---
// Blog listing page - will be available at /blog/
import { getPosts, getCategories, decodeHtmlEntities } from '../../lib/wordpress';
import BlogLayout from '../../layouts/BlogLayout.astro';
import BlogCard from '../../components/BlogCard.astro';

// Fetch posts at build time
let posts: any[] = [];
let categories: any[] = [];
let error: string | null = null;

try {
  posts = await getPosts('per_page=20');
  categories = await getCategories();
} catch (e: any) {
  error = e.message || 'Unknown error';
  console.error('Error fetching WordPress data:', e);
}

// Helper function to get category name
function getCategoryName(categoryId: number) {
  const category = categories.find(cat => cat.id === categoryId);
  return category ? category.name : 'Uncategorized';
}

// Helper function to strip HTML from excerpt and decode entities
function stripHtml(html: string) {
  const decoded = decodeHtmlEntities(html);
  return decoded.replace(/<[^>]*>/g, '').trim();
}
---

<BlogLayout 
  title="Savor Blog - Food Stories & Restaurant Reviews"
  description="Discover food stories, restaurant reviews, cooking tips, and culinary adventures from around the world."
>
  <div class="mb-8">
    <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">Savor Blog</h1>
    <p class="text-xl text-gray-600">Food Stories & Restaurant Reviews</p>
  </div>
  
  {error ? (
    <div class="bg-red-50 border border-red-200 rounded-lg p-6 mb-8">
      <h2 class="text-lg font-semibold text-red-800 mb-2">Error loading posts</h2>
      <p class="text-red-600">{error}</p>
    </div>
  ) : posts.length === 0 ? (
    <div class="text-center py-16">
      <div class="max-w-md mx-auto">
        <h2 class="text-2xl font-semibold text-gray-900 mb-4">No posts yet</h2>
        <p class="text-gray-600">Check back soon for delicious content!</p>
      </div>
    </div>
  ) : (
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-1">
      {posts.map((post) => (
        <BlogCard
          title={decodeHtmlEntities(post.title.rendered)}
          excerpt={stripHtml(post.excerpt.rendered)}
          href={`/blog/${post.slug}`}
          date={post.date}
          category={post.categories.length > 0 ? getCategoryName(post.categories[0]) : undefined}
        />
      ))}
    </div>
  )}
</BlogLayout>